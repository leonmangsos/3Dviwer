<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¹…ä¼´å°è½¦ 3D æ¨¡å‹æŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            color: white;
            min-width: 200px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .control-group button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .control-group button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .control-group button.active {
            background: rgba(76, 175, 80, 0.6);
            border-color: rgba(76, 175, 80, 0.8);
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-top: 5px;
            accent-color: #4CAF50;
        }

        .file-upload {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            max-width: 500px;
        }

        .file-upload h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .file-upload p {
            margin-bottom: 20px;
            opacity: 0.8;
            line-height: 1.5;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .demo-button {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            text-align: center;
            color: white;
            background: rgba(255, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 400px;
        }

        #canvas-container {
            width: 100%;
            height: 100vh;
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            font-size: 12px;
            line-height: 1.5;
            max-width: 300px;
        }

        .instructions h3 {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .instructions ul {
            list-style: none;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .instructions li:before {
            content: "â€¢ ";
            color: #4CAF50;
            font-weight: bold;
        }

        .drag-drop-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .drag-drop-area.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .zoom-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .zoom-info.show {
            opacity: 1;
        }

        .axis-controls {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            color: white;
            min-width: 140px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .axis-controls h3 {
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
            color: #4CAF50;
        }

        .axis-group {
            margin-bottom: 15px;
        }

        .axis-group:last-child {
            margin-bottom: 0;
        }

        .axis-label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .axis-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;  /* å¢åŠ æŒ‰é’®é—´è· */
        }

        .axis-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 15px;  /* å¢åŠ æŒ‰é’®å¤§å° */
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;     /* å¢åŠ å­—ä½“å¤§å° */
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            min-height: 44px;    /* ç¡®ä¿è§¦æ‘¸å‹å¥½çš„æœ€å°é«˜åº¦ */
        }

        .axis-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .axis-btn.x-axis {
            border-color: rgba(255, 99, 99, 0.5);
            background: rgba(255, 99, 99, 0.2);
        }

        .axis-btn.x-axis:hover {
            background: rgba(255, 99, 99, 0.4);
        }

        .axis-btn.y-axis {
            border-color: rgba(99, 255, 99, 0.5);
            background: rgba(99, 255, 99, 0.2);
        }

        .axis-btn.y-axis:hover {
            background: rgba(99, 255, 99, 0.4);
        }

        .axis-btn.z-axis {
            border-color: rgba(99, 99, 255, 0.5);
            background: rgba(99, 99, 255, 0.2);
        }

        .axis-btn.z-axis:hover {
            background: rgba(99, 99, 255, 0.4);
        }

        .rotation-speed {
            margin-top: 15px;
            text-align: center;
        }

        .rotation-speed label {
            display: block;
            margin-bottom: 5px;
            font-size: 11px;
            opacity: 0.8;
        }

        .rotation-speed input[type="range"] {
            width: 100%;
            accent-color: #4CAF50;
        }

        .rotation-speed span {
            font-size: 10px;
            opacity: 0.7;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .controls {
                position: fixed;
                bottom: 20px;
                right: 20px;
                top: auto;
                min-width: 150px;
                max-height: 60vh;
            }
            
            .axis-controls {
                left: 10px;
                min-width: 100px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .instructions {
                display: none;
            }
            
            .file-upload {
                padding: 20px;
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— é¹…ä¼´å°è½¦ 3D æ¨¡å‹</h1>
            <p>æŒ‰é”®æ“æ§ | ç§»åŠ¨ç«¯ä¼˜åŒ– | 6è‡ªç”±åº¦æ§åˆ¶</p>
        </div>

        <div class="axis-controls hidden" id="axis-controls">
            <h3>ğŸ¯ æ¨¡å‹æ§åˆ¶</h3>
            
            <!-- æ—‹è½¬æ§åˆ¶ -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #FFD700; margin-bottom: 10px; font-size: 12px;">ğŸ”„ æ—‹è½¬æ§åˆ¶</h4>
                
                <div class="axis-group">
                    <span class="axis-label">Xè½´ (çº¢è‰²)</span>
                    <div class="axis-buttons">
                        <button class="axis-btn x-axis" onclick="rotateModel('x', -1)">â†</button>
                        <button class="axis-btn x-axis" onclick="rotateModel('x', 1)">â†’</button>
                    </div>
                </div>
                
                <div class="axis-group">
                    <span class="axis-label">Yè½´ (ç»¿è‰²)</span>
                    <div class="axis-buttons">
                        <button class="axis-btn y-axis" onclick="rotateModel('y', -1)">â†“</button>
                        <button class="axis-btn y-axis" onclick="rotateModel('y', 1)">â†‘</button>
                    </div>
                </div>
                
                <div class="axis-group">
                    <span class="axis-label">Zè½´ (è“è‰²)</span>
                    <div class="axis-buttons">
                        <button class="axis-btn z-axis" onclick="rotateModel('z', -1)">âŸ²</button>
                        <button class="axis-btn z-axis" onclick="rotateModel('z', 1)">âŸ³</button>
                    </div>
                </div>
            </div>
            
            <!-- ä½ç½®æ§åˆ¶ -->
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00CED1; margin-bottom: 10px; font-size: 12px;">ğŸ“ ä½ç½®æ§åˆ¶</h4>
                
                <div class="axis-group">
                    <span class="axis-label">å·¦å³ç§»åŠ¨</span>
                    <div class="axis-buttons">
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('x', -1)">â†</button>
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('x', 1)">â†’</button>
                    </div>
                </div>
                
                <div class="axis-group">
                    <span class="axis-label">ä¸Šä¸‹ç§»åŠ¨</span>
                    <div class="axis-buttons">
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('y', -1)">â†“</button>
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('y', 1)">â†‘</button>
                    </div>
                </div>
                
                <div class="axis-group">
                    <span class="axis-label">å‰åç§»åŠ¨</span>
                    <div class="axis-buttons">
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('z', -1)">â¬‡</button>
                        <button class="axis-btn" style="background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.5);" onclick="moveModel('z', 1)">â¬†</button>
                    </div>
                </div>
            </div>
            
            <div class="rotation-speed">
                <label>ç§»åŠ¨/æ—‹è½¬é€Ÿåº¦</label>
                <input type="range" id="rotationSpeed" min="0.5" max="5" step="0.5" value="2" onchange="updateRotationSpeed()">
                <span id="speedValue">2x</span>
            </div>
        </div>

        <div class="controls hidden" id="controls">
            <div class="control-group">
                <label>æ–‡ä»¶æ“ä½œ</label>
                <button onclick="showFileUpload()">ğŸ“‚ åŠ è½½æ–°æ¨¡å‹</button>
                <button onclick="resetCamera()">ğŸ”„ é‡ç½®è§†è§’</button>
                <button onclick="toggleWireframe()" id="wireframeBtn">ğŸ“ çº¿æ¡†æ¨¡å¼</button>
                <button onclick="toggleAxisControls()" id="axisControlBtn">ğŸ¯ æ¨¡å‹æ§åˆ¶</button>
            </div>
            
            <div class="control-group">
                <label>ç¼©æ”¾æ§åˆ¶</label>
                <button onclick="zoomIn()">ğŸ” æ”¾å¤§</button>
                <button onclick="zoomOut()">ğŸ” ç¼©å°</button>
                <button onclick="fitToScreen()">ğŸ“ é€‚åº”å±å¹•</button>
                <button onclick="resetModelRotation()">ğŸ”„ é‡ç½®ä½ç½®</button>
            </div>
            
            <div class="control-group">
                <label>å…‰ç…§å¼ºåº¦</label>
                <input type="range" id="lightIntensity" min="0" max="3" step="0.1" value="1.5" onchange="updateLighting()">
                <span id="lightValue">1.5</span>
            </div>
            
            <div class="control-group">
                <label>æ¨¡å‹é¢œè‰²</label>
                <button onclick="changeColor('#ff6b6b')" style="background: #ff6b6b;">çº¢è‰²</button>
                <button onclick="changeColor('#4ecdc4')" style="background: #4ecdc4;">é’è‰²</button>
                <button onclick="changeColor('#45b7d1')" style="background: #45b7d1;">è“è‰²</button>
                <button onclick="changeColor('#96ceb4')" style="background: #96ceb4;">ç»¿è‰²</button>
                <button onclick="changeColor('#ffeaa7')" style="background: #ffeaa7;">é»„è‰²</button>
                <button onclick="changeColor('#dda0dd')" style="background: #dda0dd;">ç´«è‰²</button>
            </div>
            
            <div class="control-group">
                <label>èƒŒæ™¯ä¸»é¢˜</label>
                <button onclick="changeBackground('gradient')" id="bgGradient" class="active">æ¸å˜</button>
                <button onclick="changeBackground('dark')" id="bgDark">æ·±è‰²</button>
                <button onclick="changeBackground('light')" id="bgLight">æµ…è‰²</button>
            </div>
        </div>

        <div id="file-upload" class="file-upload hidden">
            <h2>ğŸ“ é€‰æ‹©å…¶ä»– 3D æ¨¡å‹æ–‡ä»¶</h2>
            <p>æ”¯æŒ STL æ ¼å¼çš„ 3D æ¨¡å‹æ–‡ä»¶<br>
            æ–‡ä»¶å¤§å°å»ºè®®ä¸è¶…è¿‡ 50MB</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".stl" onchange="handleFileSelect(event)">
                <button class="file-input-button">ğŸ“‚ é€‰æ‹©æ–‡ä»¶</button>
            </div>
            
            <div class="drag-drop-area" id="dragDropArea">
                <p>æˆ–è€…å°† STL æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ</p>
            </div>
            
            <div style="margin-top: 20px;">
                <p style="font-size: 12px; opacity: 0.7;">
                    GitHub Pages éƒ¨ç½²ç‰ˆæœ¬ | 
                    <a href="https://github.com" target="_blank" style="color: #4CAF50;">æŸ¥çœ‹æºç </a>
                </p>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨åŠ è½½ 3D æ¨¡å‹...</p>
        </div>

        <div id="error" class="error hidden">
            <h3>âŒ åŠ è½½å¤±è´¥</h3>
            <p id="error-message">æ— æ³•åŠ è½½ 3D æ¨¡å‹æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</p>
            <button class="demo-button" onclick="showFileUpload()" style="margin-top: 15px;">é‡æ–°é€‰æ‹©æ–‡ä»¶</button>
        </div>

        <div id="canvas-container"></div>

        <div class="instructions hidden" id="instructions">
            <h3>ğŸ® æ¨èï¼šæŒ‰é”®æ“æ§</h3>
            <ul>
                <li><strong>æ–¹å‘é”®ï¼šç§»åŠ¨æ¨¡å‹ä½ç½®</strong></li>
                <li><strong>Q/E/A/D/Z/Cï¼šæ—‹è½¬æ§åˆ¶</strong></li>
                <li>é¼ æ ‡å·¦é”®æ‹–æ‹½ï¼šæ—‹è½¬è§†è§’</li>
                <li>é¼ æ ‡å³é”®æ‹–æ‹½ï¼šå¹³ç§»è§†è§’</li>
                <li>é¼ æ ‡æ»šè½®ï¼šç¼©æ”¾æ¨¡å‹</li>
                <li>åŒå‡»ï¼šå¿«é€Ÿé€‚åº”å±å¹•</li>
                <li>Té”®ï¼šæ˜¾ç¤º/éšè—æ¨¡å‹æ§åˆ¶</li>
                <li>Shift+Rï¼šé‡ç½®ä½ç½®å’Œæ—‹è½¬</li>
            </ul>
        </div>

        <div id="zoom-info" class="zoom-info">
            ç¼©æ”¾: <span id="zoom-level">100%</span>
        </div>
    </div>

    <!-- Three.js åº“ - ä½¿ç”¨ç¨³å®šç‰ˆæœ¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- STL åŠ è½½å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <!-- è½¨é“æ§åˆ¶å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let model, originalMaterial;
        let ambientLight, directionalLight;
        let isWireframe = false;
        let modelBoundingBox, modelSize, modelCenter;
        let initialCameraDistance = 10;
        let zoomLevel = 1;
        let rotationSpeed = 2;
        let isAxisControlsVisible = true;  // é»˜è®¤æ˜¾ç¤ºæ§åˆ¶é¢æ¿

        // åˆå§‹åŒ– 3D åœºæ™¯
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            
            // åˆ›å»ºç›¸æœº - ä¼˜åŒ–è§†è§’å‚æ•°
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 10000);
            camera.position.set(5, 5, 5);
            
            // åˆ›å»ºæ¸²æŸ“å™¨ - ä¼˜åŒ–æ¸²æŸ“å‚æ•°
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x000000, 0);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // å°†æ¸²æŸ“å™¨æ·»åŠ åˆ°é¡µé¢
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // åˆ›å»ºè½¨é“æ§åˆ¶å™¨ - ä¼˜åŒ–ç¼©æ”¾å‚æ•°
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;  // å¯ç”¨å±å¹•ç©ºé—´å¹³ç§»
            controls.enablePan = true;           // ç¡®ä¿å¹³ç§»åŠŸèƒ½å¯ç”¨
            controls.minDistance = 0.1;
            controls.maxDistance = 1000;
            controls.maxPolarAngle = Math.PI;
            
            // ä¼˜åŒ–ç¼©æ”¾å‚æ•°
            controls.zoomSpeed = 1.2;
            controls.panSpeed = 1.0;             // å¢åŠ å¹³ç§»é€Ÿåº¦
            controls.rotateSpeed = 0.5;
            
            // ç›‘å¬æ§åˆ¶å™¨å˜åŒ–
            controls.addEventListener('change', updateZoomInfo);
            
            // è®¾ç½®å…‰ç…§
            setupLighting();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', onWindowResize, false);
            
            // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
            setupDragDrop();
            
            // æ·»åŠ åŒå‡»äº‹ä»¶
            renderer.domElement.addEventListener('dblclick', fitToScreen);
            
            // ç›´æ¥åŠ è½½é»˜è®¤æ¨¡å‹
            loadDefaultModel();
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();
        }

        // è®¾ç½®å…‰ç…§ - ä¼˜åŒ–å…‰ç…§æ•ˆæœ
        function setupLighting() {
            // ç¯å¢ƒå…‰
            ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            // ä¸»æ–¹å‘å…‰
            directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            scene.add(directionalLight);
            
            // è¡¥å……å…‰æº
            const light2 = new THREE.DirectionalLight(0xffffff, 0.8);
            light2.position.set(-10, -10, -5);
            scene.add(light2);
            
            // é¡¶éƒ¨å…‰æº
            const light3 = new THREE.DirectionalLight(0xffffff, 0.6);
            light3.position.set(0, 20, 0);
            scene.add(light3);
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragDrop() {
            const dragDropArea = document.getElementById('dragDropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, unhighlight, false);
            });

            dragDropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dragDropArea.classList.add('dragover');
            }

            function unhighlight(e) {
                dragDropArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    loadSTLFromFile(files[0]);
                }
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                loadSTLFromFile(file);
            }
        }

        // ä»æ–‡ä»¶åŠ è½½ STL æ¨¡å‹
        function loadSTLFromFile(file) {
            if (!file.name.toLowerCase().endsWith('.stl')) {
                showError('è¯·é€‰æ‹© STL æ ¼å¼çš„æ–‡ä»¶ï¼');
                return;
            }

            if (file.size > 50 * 1024 * 1024) { // 50MB é™åˆ¶
                showError('æ–‡ä»¶å¤ªå¤§ï¼è¯·é€‰æ‹©å°äº 50MB çš„æ–‡ä»¶ã€‚');
                return;
            }

            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                loadSTLFromArrayBuffer(arrayBuffer);
            };
            reader.onerror = function() {
                showError('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            };
            reader.readAsArrayBuffer(file);
        }

        // ä» ArrayBuffer åŠ è½½ STL
        function loadSTLFromArrayBuffer(arrayBuffer) {
            const loader = new THREE.STLLoader();
            
            try {
                const geometry = loader.parse(arrayBuffer);
                createModelFromGeometry(geometry);
            } catch (error) {
                console.error('STL è§£æå¤±è´¥:', error);
                showError('STL æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æï¼');
            }
        }

        // åŠ è½½é»˜è®¤æ¨¡å‹
        function loadDefaultModel() {
            showLoading();
            
            const loader = new THREE.STLLoader();
            loader.load(
                'é¹…ä¼´å°è½¦.stl',
                function (geometry) {
                    createModelFromGeometry(geometry);
                },
                function (progress) {
                    console.log('åŠ è½½è¿›åº¦:', (progress.loaded / progress.total * 100) + '%');
                },
                function (error) {
                    console.error('é»˜è®¤æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    // å¦‚æœé»˜è®¤æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç•Œé¢
                    showFileUpload();
                }
            );
        }

        // ä»å‡ ä½•ä½“åˆ›å»ºæ¨¡å‹ - ä¼˜åŒ–ç¼©æ”¾é€»è¾‘
        function createModelFromGeometry(geometry) {
            // æ¸…é™¤ç°æœ‰æ¨¡å‹
            if (model) {
                scene.remove(model);
                model.geometry.dispose();
                model.material.dispose();
            }
            
            // è®¡ç®—å‡ ä½•ä½“çš„æ³•å‘é‡
            geometry.computeVertexNormals();
            
            // åˆ›å»ºæè´¨
            const material = new THREE.MeshPhongMaterial({
                color: 0x4ecdc4,
                shininess: 100,
                specular: 0x111111,
                side: THREE.DoubleSide
            });
            
            // åˆ›å»ºç½‘æ ¼
            model = new THREE.Mesh(geometry, material);
            originalMaterial = material;
            
            // å¯ç”¨é˜´å½±
            model.castShadow = true;
            model.receiveShadow = true;
            
            // è®¡ç®—æ¨¡å‹çš„è¾¹ç•Œç›’å’Œå°ºå¯¸
            modelBoundingBox = new THREE.Box3().setFromObject(model);
            modelCenter = modelBoundingBox.getCenter(new THREE.Vector3());
            modelSize = modelBoundingBox.getSize(new THREE.Vector3());
            
            // å°†æ¨¡å‹å±…ä¸­
            model.position.sub(modelCenter);
            
            // è®¡ç®—åˆé€‚çš„ç›¸æœºè·ç¦»
            const maxDim = Math.max(modelSize.x, modelSize.y, modelSize.z);
            initialCameraDistance = maxDim * 2;
            
            // è®¾ç½®ç›¸æœºå‚æ•°
            camera.near = maxDim * 0.001;
            camera.far = maxDim * 100;
            camera.updateProjectionMatrix();
            
            // è®¾ç½®æ§åˆ¶å™¨è·ç¦»é™åˆ¶
            controls.minDistance = maxDim * 0.1;
            controls.maxDistance = maxDim * 10;
            
            // æ·»åŠ åˆ°åœºæ™¯
            scene.add(model);
            
            // é€‚åº”å±å¹•
            fitToScreen();
            
            // æ˜¾ç¤ºæ¨¡å‹è§†å›¾
            showModelView();
            
            console.log('æ¨¡å‹åŠ è½½æˆåŠŸ');
            console.log('æ¨¡å‹å°ºå¯¸:', modelSize);
            console.log('åˆå§‹ç›¸æœºè·ç¦»:', initialCameraDistance);
        }

        // é€‚åº”å±å¹• - ä¼˜åŒ–çš„ç¼©æ”¾é€»è¾‘
        function fitToScreen() {
            if (!model) return;
            
            const maxDim = Math.max(modelSize.x, modelSize.y, modelSize.z);
            const fov = camera.fov * (Math.PI / 180);
            const distance = maxDim / (2 * Math.tan(fov / 2)) * 1.2;
            
            // è®¾ç½®ç›¸æœºä½ç½®
            const direction = camera.position.clone().normalize();
            camera.position.copy(direction.multiplyScalar(distance));
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.target.set(0, 0, 0);
            controls.update();
            
            // é‡ç½®ç¼©æ”¾çº§åˆ«
            zoomLevel = 1;
            updateZoomInfo();
        }

        // æ”¾å¤§
        function zoomIn() {
            if (!model) return;
            const currentDistance = camera.position.distanceTo(controls.target);
            const newDistance = currentDistance * 0.8;
            if (newDistance > controls.minDistance) {
                const direction = camera.position.clone().sub(controls.target).normalize();
                camera.position.copy(controls.target).add(direction.multiplyScalar(newDistance));
                controls.update();
                updateZoomInfo();
            }
        }

        // ç¼©å°
        function zoomOut() {
            if (!model) return;
            const currentDistance = camera.position.distanceTo(controls.target);
            const newDistance = currentDistance * 1.25;
            if (newDistance < controls.maxDistance) {
                const direction = camera.position.clone().sub(controls.target).normalize();
                camera.position.copy(controls.target).add(direction.multiplyScalar(newDistance));
                controls.update();
                updateZoomInfo();
            }
        }

        // æ›´æ–°ç¼©æ”¾ä¿¡æ¯æ˜¾ç¤º
        function updateZoomInfo() {
            if (!model) return;
            
            const currentDistance = camera.position.distanceTo(controls.target);
            zoomLevel = initialCameraDistance / currentDistance;
            
            const zoomPercentage = Math.round(zoomLevel * 100);
            document.getElementById('zoom-level').textContent = zoomPercentage + '%';
            
            // æ˜¾ç¤ºç¼©æ”¾ä¿¡æ¯
            const zoomInfo = document.getElementById('zoom-info');
            zoomInfo.classList.add('show');
            
            // 3ç§’åéšè—
            clearTimeout(window.zoomInfoTimeout);
            window.zoomInfoTimeout = setTimeout(() => {
                zoomInfo.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('file-upload').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('file-upload').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç•Œé¢
        function showFileUpload() {
            document.getElementById('file-upload').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('zoom-info').classList.remove('show');
        }

        // æ˜¾ç¤ºæ¨¡å‹è§†å›¾
        function showModelView() {
            document.getElementById('file-upload').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('instructions').classList.remove('hidden');
            
            // é»˜è®¤æ˜¾ç¤ºè½´æ§åˆ¶é¢æ¿
            document.getElementById('axis-controls').classList.remove('hidden');
            const btn = document.getElementById('axisControlBtn');
            btn.classList.add('active');
            btn.textContent = 'ğŸ¯ éšè—æ§åˆ¶';
        }

        // åˆ‡æ¢è½´æ§åˆ¶é¢æ¿æ˜¾ç¤º
        function toggleAxisControls() {
            const axisControls = document.getElementById('axis-controls');
            const btn = document.getElementById('axisControlBtn');
            
            isAxisControlsVisible = !isAxisControlsVisible;
            
            if (isAxisControlsVisible) {
                axisControls.classList.remove('hidden');
                btn.classList.add('active');
                btn.textContent = 'ğŸ¯ éšè—æ§åˆ¶';
            } else {
                axisControls.classList.add('hidden');
                btn.classList.remove('active');
                btn.textContent = 'ğŸ¯ æ¨¡å‹æ§åˆ¶';
            }
        }

        // ç§»åŠ¨æ¨¡å‹ä½ç½® - æ–°å¢åŠŸèƒ½
        function moveModel(axis, direction) {
            if (!model) return;
            
            // è®¡ç®—ç§»åŠ¨è·ç¦»ï¼ˆåŸºäºæ¨¡å‹å¤§å°å’Œé€Ÿåº¦ï¼‰
            const maxDim = Math.max(modelSize.x, modelSize.y, modelSize.z);
            const moveDistance = (maxDim * 0.1) * rotationSpeed * direction;
            
            // æš‚æ—¶ç¦ç”¨è½¨é“æ§åˆ¶å™¨ï¼Œé¿å…å†²çª
            controls.enabled = false;
            
            // æ ¹æ®è½´å‘è¿›è¡Œç§»åŠ¨
            switch(axis) {
                case 'x':
                    model.position.x += moveDistance;
                    break;
                case 'y':
                    model.position.y += moveDistance;
                    break;
                case 'z':
                    model.position.z += moveDistance;
                    break;
            }
            
            // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¯ç”¨æ§åˆ¶å™¨
            setTimeout(() => {
                controls.enabled = true;
            }, 100);
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            showMovementFeedback(axis, direction);
        }

        // æ˜¾ç¤ºç§»åŠ¨åé¦ˆ
        function showMovementFeedback(axis, direction) {
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 165, 0, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                pointer-events: none;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 165, 0, 0.5);
            `;
            
            const axisNames = {
                'x': 'å·¦å³',
                'y': 'ä¸Šä¸‹', 
                'z': 'å‰å'
            };
            
            const directionText = {
                'x': direction > 0 ? 'å³ç§»' : 'å·¦ç§»',
                'y': direction > 0 ? 'ä¸Šç§»' : 'ä¸‹ç§»',
                'z': direction > 0 ? 'å‰ç§»' : 'åç§»'
            };
            
            feedback.textContent = `ğŸ“ ${axisNames[axis]}${directionText[axis]}`;
            
            document.body.appendChild(feedback);
            
            // 1ç§’åç§»é™¤åé¦ˆ
            setTimeout(() => {
                if (document.body.contains(feedback)) {
                    document.body.removeChild(feedback);
                }
            }, 1000);
        }

        // é‡ç½®æ¨¡å‹ä½ç½®
        function resetModelPosition() {
            if (!model) return;
            
            model.position.set(0, 0, 0);
            showMovementFeedback('reset', 0);
        }

        // æ—‹è½¬æ¨¡å‹ - æ ¸å¿ƒåŠŸèƒ½
        function rotateModel(axis, direction) {
            if (!model) return;
            
            // è®¡ç®—æ—‹è½¬è§’åº¦ï¼ˆåŸºäºé€Ÿåº¦ï¼‰
            const angle = (Math.PI / 180) * 15 * rotationSpeed * direction;
            
            // æš‚æ—¶ç¦ç”¨è½¨é“æ§åˆ¶å™¨ï¼Œé¿å…å†²çª
            controls.enabled = false;
            
            // æ ¹æ®è½´å‘è¿›è¡Œæ—‹è½¬
            switch(axis) {
                case 'x':
                    model.rotateX(angle);
                    break;
                case 'y':
                    model.rotateY(angle);
                    break;
                case 'z':
                    model.rotateZ(angle);
                    break;
            }
            
            // çŸ­æš‚å»¶è¿Ÿåé‡æ–°å¯ç”¨æ§åˆ¶å™¨
            setTimeout(() => {
                controls.enabled = true;
            }, 100);
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            showRotationFeedback(axis, direction);
        }

        // æ˜¾ç¤ºæ—‹è½¬åé¦ˆ
        function showRotationFeedback(axis, direction) {
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                pointer-events: none;
                backdrop-filter: blur(10px);
            `;
            
            const axisColors = {
                'x': 'ğŸ”´',
                'y': 'ğŸŸ¢', 
                'z': 'ğŸ”µ'
            };
            
            const directionText = direction > 0 ? 'é¡ºæ—¶é’ˆ' : 'é€†æ—¶é’ˆ';
            feedback.textContent = `${axisColors[axis]} ${axis.toUpperCase()}è½´ ${directionText}æ—‹è½¬`;
            
            document.body.appendChild(feedback);
            
            // 1ç§’åç§»é™¤åé¦ˆ
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 1000);
        }

        // æ›´æ–°æ—‹è½¬é€Ÿåº¦
        function updateRotationSpeed() {
            rotationSpeed = parseFloat(document.getElementById('rotationSpeed').value);
            document.getElementById('speedValue').textContent = rotationSpeed + 'x';
        }

        // é‡ç½®æ¨¡å‹æ—‹è½¬å’Œä½ç½®
        function resetModelRotation() {
            if (!model) return;
            
            model.rotation.set(0, 0, 0);
            model.position.set(0, 0, 0);
            
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                pointer-events: none;
                backdrop-filter: blur(10px);
            `;
            feedback.textContent = 'ğŸ”„ å·²é‡ç½®æ—‹è½¬å’Œä½ç½®';
            
            document.body.appendChild(feedback);
            setTimeout(() => {
                if (document.body.contains(feedback)) {
                    document.body.removeChild(feedback);
                }
            }, 1500);
        }

        // æ¸²æŸ“å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();
            
            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }

        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // é‡ç½®ç›¸æœºä½ç½®
        function resetCamera() {
            if (model) {
                fitToScreen();
            }
        }

        // åˆ‡æ¢çº¿æ¡†æ¨¡å¼
        function toggleWireframe() {
            if (model) {
                isWireframe = !isWireframe;
                model.material.wireframe = isWireframe;
                
                const btn = document.getElementById('wireframeBtn');
                btn.classList.toggle('active', isWireframe);
                btn.textContent = isWireframe ? 'ğŸ“ å®ä½“æ¨¡å¼' : 'ğŸ“ çº¿æ¡†æ¨¡å¼';
            }
        }

        // æ›´æ–°å…‰ç…§å¼ºåº¦
        function updateLighting() {
            const intensity = parseFloat(document.getElementById('lightIntensity').value);
            document.getElementById('lightValue').textContent = intensity.toFixed(1);
            
            if (directionalLight) {
                directionalLight.intensity = intensity;
            }
        }

        // æ”¹å˜æ¨¡å‹é¢œè‰²
        function changeColor(color) {
            if (model) {
                model.material.color.setHex(color.replace('#', '0x'));
            }
        }

        // æ”¹å˜èƒŒæ™¯
        function changeBackground(type) {
            const body = document.body;
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active ç±»
            document.querySelectorAll('[id^="bg"]').forEach(btn => btn.classList.remove('active'));
            
            switch(type) {
                case 'gradient':
                    body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    document.getElementById('bgGradient').classList.add('active');
                    break;
                case 'dark':
                    body.style.background = '#2c3e50';
                    document.getElementById('bgDark').classList.add('active');
                    break;
                case 'light':
                    body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                    document.getElementById('bgLight').classList.add('active');
                    break;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.target.tagName === 'INPUT') return; // å¿½ç•¥è¾“å…¥æ¡†ä¸­çš„æŒ‰é”®
            
            switch(event.code) {
                case 'KeyR':
                    if (event.shiftKey) {
                        resetModelRotation();
                    } else {
                        resetCamera();
                    }
                    break;
                case 'KeyW':
                    toggleWireframe();
                    break;
                case 'KeyF':
                    fitToScreen();
                    break;
                case 'KeyT':
                    toggleAxisControls();
                    break;
                case 'Equal':
                case 'NumpadAdd':
                    zoomIn();
                    break;
                case 'Minus':
                case 'NumpadSubtract':
                    zoomOut();
                    break;
                // Xè½´æ—‹è½¬ (Q/Eé”®)
                case 'KeyQ':
                    rotateModel('x', -1);
                    break;
                case 'KeyE':
                    rotateModel('x', 1);
                    break;
                // Yè½´æ—‹è½¬ (A/Dé”®)
                case 'KeyA':
                    rotateModel('y', -1);
                    break;
                case 'KeyD':
                    rotateModel('y', 1);
                    break;
                // Zè½´æ—‹è½¬ (Z/Cé”®)
                case 'KeyZ':
                    rotateModel('z', -1);
                    break;
                case 'KeyC':
                    rotateModel('z', 1);
                    break;
                // ä½ç½®ç§»åŠ¨ (æ–¹å‘é”®)
                case 'ArrowLeft':
                    event.preventDefault();
                    moveModel('x', -1);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    moveModel('x', 1);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    if (event.shiftKey) {
                        moveModel('z', 1); // Shift+ä¸Šç®­å¤´ï¼šå‰ç§»
                    } else {
                        moveModel('y', 1); // ä¸Šç®­å¤´ï¼šä¸Šç§»
                    }
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    if (event.shiftKey) {
                        moveModel('z', -1); // Shift+ä¸‹ç®­å¤´ï¼šåç§»
                    } else {
                        moveModel('y', -1); // ä¸‹ç®­å¤´ï¼šä¸‹ç§»
                    }
                    break;
                // é¢œè‰²å¿«æ·é”®
                case 'Digit1':
                    changeColor('#ff6b6b');
                    break;
                case 'Digit2':
                    changeColor('#4ecdc4');
                    break;
                case 'Digit3':
                    changeColor('#45b7d1');
                    break;
                case 'Digit4':
                    changeColor('#96ceb4');
                    break;
            }
        });

        // é˜²æ­¢é¡µé¢æ»šåŠ¨å½±å“3Dæ§åˆ¶
        document.addEventListener('wheel', function(e) {
            if (e.target.closest('#canvas-container')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>